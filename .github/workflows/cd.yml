name: CD - Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push datalens-bot
        uses: docker/build-push-action@v5
        with:
          context: ./apps/datalens-bot
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/datalens-bot:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push provider-downs
        uses: docker/build-push-action@v5
        with:
          context: ./apps/provider-downs
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/provider-downs:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            cd /opt/parsers
            
            echo "=== Проверяем первый запуск ==="
            if [ ! -f /opt/parsers/.first_run_completed ]; then
              echo "⚠️  FIRST RUN DETECTED"
              FIRST_RUN_MODE=true
            else
              echo "✅ Normal deployment"
              FIRST_RUN_MODE=false
            fi
            
            echo "=== Создаем .env файл ==="
            cat > .env << 'ENVEOF'
            TG_BOT_TOKEN=${{ secrets.TG_BOT_TOKEN }}
            TG_CHAT_ID=${{ secrets.TG_CHAT_ID }}
            GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD }}
            GRAFANA_USER=${{ secrets.GRAFANA_USER }}
            ENVEOF
            echo "FIRST_RUN=${FIRST_RUN_MODE}" >> .env
            chmod 600 .env
            
            echo "=== Создаем Google Sheets credentials ==="
            mkdir -p apps/provider-downs
            cat > apps/provider-downs/provider-falls-ea0c76990c0c.json << 'CREDEOF'
            ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
            CREDEOF
            chmod 600 apps/provider-downs/provider-falls-ea0c76990c0c.json
            
            echo "=== Логинимся в GHCR ==="
            echo ${{ secrets.GHCR_TOKEN }} | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
            
            echo "=== Скачиваем docker-compose.yml ==="
            rm -f docker-compose.yml
            curl -fsSL -o docker-compose.yml https://raw.githubusercontent.com/${{ github.repository }}/main/docker-compose.yml
            
            echo "=== Создаем директории для мониторинга ==="
            mkdir -p monitoring/grafana-dashboards
            mkdir -p monitoring/ssl
            
            echo "=== Скачиваем конфиги мониторинга ==="
            rm -f monitoring/nginx.conf
            curl -fsSL -o monitoring/nginx.conf https://raw.githubusercontent.com/${{ github.repository }}/main/monitoring/nginx.conf
            
            rm -f monitoring/prometheus.yml
            curl -fsSL -o monitoring/prometheus.yml https://raw.githubusercontent.com/${{ github.repository }}/main/monitoring/prometheus.yml
            
            rm -f monitoring/grafana-datasources.yml
            curl -fsSL -o monitoring/grafana-datasources.yml https://raw.githubusercontent.com/${{ github.repository }}/main/monitoring/grafana-datasources.yml
            
            rm -f monitoring/grafana-dashboards/dashboard.yml
            curl -fsSL -o monitoring/grafana-dashboards/dashboard.yml https://raw.githubusercontent.com/${{ github.repository }}/main/monitoring/grafana-dashboards/dashboard.yml
            
            rm -f monitoring/grafana-dashboards/parsers-infrastructure.json
            curl -fsSL -o monitoring/grafana-dashboards/parsers-infrastructure.json https://raw.githubusercontent.com/${{ github.repository }}/main/monitoring/grafana-dashboards/parsers-infrastructure.json
            
            echo "=== Генерируем SSL сертификат если нет ==="
            if [ ! -f monitoring/ssl/self-signed.crt ]; then
              openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout monitoring/ssl/self-signed.key \
                -out monitoring/ssl/self-signed.crt \
                -subj "/C=RU/ST=Moscow/L=Moscow/O=Parsers/CN=localhost"
              chmod 600 monitoring/ssl/self-signed.key
            fi
            
            echo "=== Пулим свежие образы ==="
            docker compose pull
            
            echo "=== Останавливаем старые контейнеры ==="
            docker compose down
            
            if [ "$FIRST_RUN_MODE" = "true" ]; then
              echo ""
              echo "=========================================="
              echo "⚠️  FIRST RUN MODE ACTIVE"
              echo "=========================================="
              echo "1. SSH to server: ssh root@${{ secrets.SERVER_IP }}"
              echo "2. cd /opt/parsers && docker compose up datalens-bot"
              echo "3. Open VNC http://${{ secrets.SERVER_IP }}:7900"
              echo "4. Login to Yandex, wait for cookies to save"
              echo "5. Ctrl+C, then: touch .first_run_completed"
              echo "6. docker compose up -d"
              echo "=========================================="
              exit 0
            fi
            
            echo "=== Запускаем контейнеры ==="
            docker compose up -d
            
            echo "=== Ждем запуска сервисов ==="
            sleep 15
            
            echo "=== Статус контейнеров ==="
            docker compose ps
            
            echo "=== Чистим старые образы ==="
            docker image prune -af --filter "until=24h"
            
            echo "✅ Deployment completed!"