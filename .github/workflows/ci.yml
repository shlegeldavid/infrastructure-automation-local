name: CI - Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-python:
    name: Build Python Parser
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build datalens-bot image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/datalens-bot
          push: false
          load: true  # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π Docker –¥–ª—è —Ç–µ—Å—Ç–æ–≤
          tags: datalens-bot:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Smoke test - Python parser starts
        run: |
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ç–∞–π–º–∞—É—Ç–æ–º 10 —Å–µ–∫—É–Ω–¥
          docker run --rm -d --name smoke-test-python \
            -e TG_BOT_TOKEN=test \
            -e TG_CHAT_ID=test \
            -e SELENIUM_HOST=http://fake:4444 \
            datalens-bot:test
          
          # –ñ–¥—ë–º 5 —Å–µ–∫—É–Ω–¥
          sleep 5
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è (–Ω–µ —É–ø–∞–ª —Å—Ä–∞–∑—É)
          if docker ps | grep -q smoke-test-python; then
            echo "‚úÖ Python parser started successfully"
            docker stop smoke-test-python
            exit 0
          else
            echo "‚ùå Python parser failed to start"
            docker logs smoke-test-python || true
            exit 1
          fi

  build-csharp:
    name: Build C# Parser
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build provider-downs image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/provider-downs
          push: false
          load: true
          tags: provider-downs:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Smoke test - C# parser starts
        run: |
          # –°–æ–∑–¥–∞—ë–º —Ñ–µ–π–∫–æ–≤—ã–π credentials —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∞
          mkdir -p /tmp/test-creds
          echo '{"type":"service_account","project_id":"test"}' > /tmp/test-creds/provider-falls-ea0c76990c0c.json
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          docker run --rm -d --name smoke-test-csharp \
            -v /tmp/test-creds/provider-falls-ea0c76990c0c.json:/app/provider-falls-ea0c76990c0c.json:ro \
            provider-downs:test
          
          # –ñ–¥—ë–º 5 —Å–µ–∫—É–Ω–¥
          sleep 5
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—É—Å–∫
          if docker ps -a | grep -q smoke-test-csharp; then
            echo "‚úÖ C# parser container created"
            docker logs smoke-test-csharp || true
            docker rm -f smoke-test-csharp || true
            exit 0
          else
            echo "‚ùå C# parser failed"
            exit 1
          fi

  security-scan-python:
    name: Security Scan - Python
    runs-on: ubuntu-latest
    needs: build-python
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build image for scanning
        run: docker build -t datalens-bot:scan ./apps/datalens-bot

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'datalens-bot:scan'
          format: 'table'
          exit-code: '0'  # –ù–µ —Ñ–µ–π–ª–∏–º —Å–±–æ—Ä–∫—É, —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Run Trivy for secrets detection
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'datalens-bot:scan'
          format: 'table'
          scanners: 'secret'
          exit-code: '1'  # –§–µ–π–ª–∏–º –µ—Å–ª–∏ –Ω–∞—à–ª–∏ —Å–µ–∫—Ä–µ—Ç—ã!

  security-scan-csharp:
    name: Security Scan - C#
    runs-on: ubuntu-latest
    needs: build-csharp
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build image for scanning
        run: docker build -t provider-downs:scan ./apps/provider-downs

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'provider-downs:scan'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Run Trivy for secrets detection
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'provider-downs:scan'
          format: 'table'
          scanners: 'secret'
          exit-code: '1'

  validate-compose:
    name: Validate docker-compose
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: docker compose config
  
  test-monitoring:
    name: Test Monitoring Configs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞ Prometheus (–∏—Å–ø–æ–ª—å–∑—É–µ–º promtool –∏–∑ –æ–±—Ä–∞–∑–∞ prometheus)
      - name: Validate Prometheus config
        run: |
         docker run --rm --entrypoint promtool -v $(pwd)/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml \
          prom/prometheus:latest check config /etc/prometheus/prometheus.yml
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞ Nginx
      - name: Validate Nginx config
        run: |
          docker run --rm -v $(pwd)/monitoring/nginx.conf:/etc/nginx/nginx.conf:ro \
            nginx:alpine nginx -t

      # Smoke-—Ç–µ—Å—Ç Grafana
      - name: Smoke test - Grafana starts
        run: |
          # –°–æ–∑–¥–∞—ë–º —Ñ–µ–π–∫–æ–≤—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
          mkdir -p monitoring/grafana-dashboards
          touch monitoring/grafana-dashboards/dashboard.yml
          touch monitoring/grafana-datasources.yml
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º Grafana
          docker run --rm -d --name smoke-grafana \
            -e GF_SECURITY_ADMIN_PASSWORD=test \
            -p 3000:3000 \
            grafana/grafana:latest
          
          # –ñ–¥—ë–º —Å—Ç–∞—Ä—Ç–∞
          sleep 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º API (–¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å 200 OK –∏–ª–∏ JSON)
          if curl -f http://localhost:3000/api/health; then
            echo "‚úÖ Grafana is healthy"
          else
            echo "‚ùå Grafana failed to start"
            docker logs smoke-grafana
            exit 1
          fi
          
          docker stop smoke-grafana

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [security-scan-python, security-scan-csharp]
    if: always()
    steps:
      - name: Security check results
        run: |
          echo "üîí Security scans completed"
          echo "‚úÖ No secrets found in Docker images"
          echo "‚úÖ Vulnerability scans finished"
