name: CI - Build and Test

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

jobs:
  # === ЛИНТЕРЫ ===

  lint-dockerfiles:
    name: Lint Dockerfiles
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint datalens-bot Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: apps/datalens-bot/Dockerfile
          failure-threshold: error

      - name: Lint provider-downs Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: apps/provider-downs/Dockerfile
          failure-threshold: error

  lint-yaml:
    name: Lint YAML files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .
          config_data: |
            extends: default
            rules:
              line-length: disable
              truthy: disable
              comments-indentation: disable
              document-start: disable
              trailing-spaces: disable
              new-line-at-end-of-file: disable
              brackets:
                max-spaces-inside: 1

  lint-ansible:
    name: Lint Ansible
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ansible-lint
        run: pip install ansible-lint ansible

      - name: Run ansible-lint
        run: ansible-lint ansible/playbook.yml --warn-list experimental
        continue-on-error: true

  # === ВАЛИДАЦИЯ ===

  validate-terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform format check
        run: terraform -chdir=terraform fmt -check -diff
        continue-on-error: true

      - name: Terraform init
        run: terraform -chdir=terraform init -backend=false

      - name: Terraform validate
        run: terraform -chdir=terraform validate

  validate-compose:
    name: Validate docker-compose
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: docker compose config --quiet

# === БИЛДЫ ===

  build-datalens-bot:
    name: Build datalens-bot
    runs-on: ubuntu-latest
    needs:
      - lint-dockerfiles
      - validate-compose
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build datalens-bot image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/datalens-bot
          push: false
          load: true
          tags: datalens-bot:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Smoke test - datalens-bot starts
        run: |
          docker run --rm -d --name smoke-test-datalens \
            -e TG_BOT_TOKEN=test \
            -e TG_CHAT_ID=test \
            -e SELENIUM_HOST=http://fake:4444 \
            datalens-bot:test

          sleep 5

          if docker ps | grep -q smoke-test-datalens; then
            echo "✅ datalens-bot started successfully"
            docker stop smoke-test-datalens
            exit 0
          else
            echo "❌ datalens-bot failed to start"
            docker logs smoke-test-datalens || true
            exit 1
          fi

  build-payservers-bot:
    name: Build payservers-bot
    runs-on: ubuntu-latest
    needs:
      - lint-dockerfiles
      - validate-compose
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build payservers-bot image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/Pay_servers
          push: false
          load: true
          tags: payservers-bot:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Smoke test - payservers-bot starts
        run: |
          docker run --rm -d --name smoke-test-payservers \
            -e TELEGRAM_TOKEN_RUVDS=test \
            -e CHAT_ID_RUVDS=test \
            -e RUVDS_TOKEN=test \
            payservers-bot:test

          sleep 5

          if docker ps | grep -q smoke-test-payservers; then
            echo "✅ payservers-bot started successfully"
            docker stop smoke-test-payservers
            exit 0
          else
            echo "❌ payservers-bot failed to start"
            docker logs smoke-test-payservers || true
            exit 1
          fi

  build-yandex-parser:
    name: Build yandex-parser
    runs-on: ubuntu-latest
    needs:
      - lint-dockerfiles
      - validate-compose
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build yandex-parser image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/yandex_parser_v2
          push: false
          load: true
          tags: yandex-parser:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Smoke test - yandex-parser starts
        run: |
          # Создаём фейковый service_account.json
          mkdir -p /tmp/test-creds
          cat > /tmp/test-creds/service_account.json << 'EOF'
          {
            "type": "service_account",
            "project_id": "test",
            "private_key_id": "test",
            "private_key": "-----BEGIN RSA PRIVATE KEY-----\nMIIBogIBAAJBALRiMLAHudeSA2F\n-----END RSA PRIVATE KEY-----\n",
            "client_email": "test@test.iam.gserviceaccount.com",
            "client_id": "123",
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token"
          }
          EOF

          docker run --rm -d --name smoke-test-yandex \
            -e SMOKE_TEST=true \
            -e TG_BOT_TOKEN=test \
            -e TG_CHAT_ID=test \
            -v /tmp/test-creds/service_account.json:/app/service_account.json:ro \
            yandex-parser:test

          sleep 10

          if docker ps | grep -q smoke-test-yandex; then
            echo "✅ yandex-parser started successfully"
            docker logs smoke-test-yandex
            docker stop smoke-test-yandex
            exit 0
          else
            echo "❌ yandex-parser failed to start"
            docker logs smoke-test-yandex || true
            exit 1
          fi

  build-csharp:
    name: Build C# Parser
    runs-on: ubuntu-latest
    needs:
      - lint-dockerfiles
      - validate-compose
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build provider-downs image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/provider-downs
          push: false
          load: true
          tags: provider-downs:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # === БЕЗОПАСНОСТЬ ===

  security-scan-datalens:
    name: Security Scan - datalens-bot
    runs-on: ubuntu-latest
    needs: build-datalens-bot
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build image for scanning
        run: docker build -t datalens-bot:scan ./apps/datalens-bot

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'datalens-bot:scan'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Run Trivy for secrets detection
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'datalens-bot:scan'
          format: 'table'
          scanners: 'secret'
          exit-code: '1'
  
  security-scan-payservers:
    name: Security Scan - payservers-bot
    runs-on: ubuntu-latest
    needs: build-payservers-bot
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build image for scanning
        run: docker build -t payservers-bot:scan ./apps/Pay_servers

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'payservers-bot:scan'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Run Trivy for secrets detection
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'payservers-bot:scan'
          format: 'table'
          scanners: 'secret'
          exit-code: '1'
  
  security-scan-yandex:
    name: Security Scan - yandex-parser
    runs-on: ubuntu-latest
    needs: build-yandex-parser
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build image for scanning
        run: docker build -t yandex-parser:scan ./apps/yandex_parser_v2

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'yandex-parser:scan'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Run Trivy for secrets detection
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'yandex-parser:scan'
          format: 'table'
          scanners: 'secret'
          exit-code: '1'
  
  security-scan-csharp:
    name: Security Scan - C#
    runs-on: ubuntu-latest
    needs: build-csharp
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build image for scanning
        run: docker build -t provider-downs:scan ./apps/provider-downs

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'provider-downs:scan'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Run Trivy for secrets detection
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'provider-downs:scan'
          format: 'table'
          scanners: 'secret'
          exit-code: '1'

  security-scan-repo:
    name: Security Scan - Repository
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          scanners: 'secret'

  # === ТЕСТЫ МОНИТОРИНГА ===

  test-monitoring:
    name: Test Monitoring Configs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Prometheus config
        run: |
          docker run --rm --entrypoint promtool \
            -v $(pwd)/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml \
            prom/prometheus:latest check config /etc/prometheus/prometheus.yml

      - name: Validate Nginx config
        run: |
          mkdir -p monitoring/ssl
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout monitoring/ssl/self-signed.key \
            -out monitoring/ssl/self-signed.crt \
            -subj "/CN=localhost"

          echo "admin:fakepassword" > monitoring/ssl/.htpasswd

          docker run --rm \
            --add-host grafana:127.0.0.1 \
            --add-host prometheus:127.0.0.1 \
            --add-host cadvisor:127.0.0.1 \
            -v $(pwd)/monitoring/nginx.conf:/etc/nginx/nginx.conf:ro \
            -v $(pwd)/monitoring/ssl:/etc/nginx/ssl:ro \
            nginx:alpine nginx -t

      - name: Smoke test - Grafana starts
        run: |
          docker run --rm -d --name smoke-grafana \
            -e GF_SECURITY_ADMIN_PASSWORD=test \
            -p 3000:3000 \
            grafana/grafana:latest

          sleep 10

          if curl -f http://localhost:3000/api/health; then
            echo "✅ Grafana is healthy"
          else
            echo "❌ Grafana failed to start"
            docker logs smoke-grafana
            exit 1
          fi

          docker stop smoke-grafana

      - name: Smoke test - Prometheus starts
        run: |
          docker run --rm -d --name smoke-prometheus \
            -v $(pwd)/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro \
            -p 9090:9090 \
            prom/prometheus:latest

          sleep 10

          if curl -f http://localhost:9090/-/healthy; then
            echo "✅ Prometheus is healthy"
          else
            echo "❌ Prometheus failed to start"
            docker logs smoke-prometheus
            exit 1
          fi

          docker stop smoke-prometheus

  # === ИТОГОВЫЙ ОТЧЁТ ===

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    if: always()
    needs:
      - lint-dockerfiles
      - lint-yaml
      - lint-ansible
      - validate-terraform
      - validate-compose
      - build-datalens-bot
      - build-payservers-bot
      - build-yandex-parser
      - build-csharp
      - security-scan-datalens
      - security-scan-payservers
      - security-scan-yandex
      - security-scan-csharp
      - security-scan-repo
      - test-monitoring
    steps:
      - name: Generate summary
        run: |
          echo "## CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint Dockerfiles | ${{ needs.lint-dockerfiles.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint YAML | ${{ needs.lint-yaml.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint Ansible | ${{ needs.lint-ansible.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate Terraform | ${{ needs.validate-terraform.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate Compose | ${{ needs.validate-compose.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build datalens-bot | ${{ needs.build-datalens-bot.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build payservers-bot | ${{ needs.build-payservers-bot.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build yandex-parser | ${{ needs.build-yandex-parser.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build C# | ${{ needs.build-csharp.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security datalens | ${{ needs.security-scan-datalens.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security payservers | ${{ needs.security-scan-payservers.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security yandex | ${{ needs.security-scan-yandex.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security C# | ${{ needs.security-scan-csharp.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Repo | ${{ needs.security-scan-repo.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Monitoring | ${{ needs.test-monitoring.result }} |" >> $GITHUB_STEP_SUMMARY